#!/bin/bash

branch=$(git rev-parse --abbrev-ref HEAD)
branch=$(echo $branch | perl -pe 's/\//-/g')
branch=$(echo -$branch)
branch=$(echo $branch | perl -pe 's/-main//')

case $1 in
    --rm)
        echo "Auto-removing volume container 'winehome${branch}' after completing action..."
        shift
        $0 "$@"
        exitcode=$?
        docker rm winehome${branch} 2>&1 >/dev/null
        echo "Removed 'winehome${branch}' volume container"
        exit $exitcode
        ;;
    --help)
        echo "Usage: $0 [--rm] [command] [arguments]..."
        echo "e.g."
        echo "    $0"
        echo "    $0 --rm"
        echo "    $0 wineboot --init"
        echo "    $0 --rm wine explorer.exe"
        exit 0
        ;;
esac

if ! docker ps -a | grep -q winehome${branch}; then
    echo "Creating volume container 'winehome${branch}'..."
    docker create \
        --volume="/wine" \
        --name="winehome${branch}" \
        docker-wine${branch} \
        /bin/true
fi

docker run -it \
    --rm \
    --env="DISPLAY" \
    --env="USER" \
    --volume="/etc/group:/etc/group:ro" \
    --volume="/etc/passwd:/etc/passwd:ro" \
    --volume="/etc/shadow:/etc/shadow:ro" \
    --volume="/tmp/.X11-unix:/tmp/.X11-unix:ro" \
    --volumes-from="winehome${branch}" \
    --name=wine${branch} \
    docker-wine${branch} $*
